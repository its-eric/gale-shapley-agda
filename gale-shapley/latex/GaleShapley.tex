\newcommand{\GaleShapley}{%

To define the Gale-Shapley algorithm in Agda, we need a data structure which captures the state of the procedure in its various elements, in order to reason about its properties in an expressive enough manner that proofs can be written in the same manner as we have reasoned logically about the properties of the algorithm in chapter \ref{Chapter3}. We make use here of Agda's record types.

In Agda syntax, a $record$ defines a type that groups some values, in our case, the details of the group of men and women and their preference lists for the "matching ritual". Men are preference lists indexed over a representative natural number as well as women, giving a similar "state space" to the problem as the one defined in the previous mathematical specification. This type can be constructed with the $mkState$ keyword, and its elements are accessible at all times through (pattern matching and) projection functions defined automatically by Agda.

Two extra functions are also defined, $lengthPrefs$ and $compSumPrefLists$ which help us calculate the length of the preference lists of men in a matching state:

\begin{code}[hide]%
\>[0]\<%
\\
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{GaleShapley}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Agda.Builtin.String}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Agda.Builtin.Equality}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Empty}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Maybe}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat.Properties}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Product}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Bool}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.List}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Sum}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Nullary}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Induction.WellFounded}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Binary.PropositionalEquality}\<%
\\
\>[0]\<%
\\
\>[0]\AgdaKeyword{infix}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}>just\AgdaUnderscore{}}}\<%
\\
\>[0]\AgdaKeyword{infix}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\<%
\end{code}

\begin{code}%
\>[0]\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{ℕ}\<%
\\
\>[0]\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaNumber{0}\<%
\\
\>[0]\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaSymbol{((\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{xs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{xs}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{compSumPrefLists}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{ℕ}\<%
\\
\>[0]\AgdaFunction{compSumPrefLists}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{engagedMen}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{record}\AgdaSpace{}%
\AgdaRecord{MatchingState}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{constructor}\AgdaSpace{}%
\AgdaInductiveConstructor{mkState}\<%
\\
%
\>[2]\AgdaKeyword{field}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaField{men}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaField{freeMen}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaField{engagedMen}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaField{women}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaField{couples}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaField{sumPrefLists}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\<%
\\
%
\>[4]\AgdaField{sumEq}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{sumPrefLists}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{engagedMen}\<%
\end{code}

We expect to start the execution of the algorithm with a copy of all men in the $freeMen$ list, and finish with all of them in $engagedMen$. A list of couples can then be extracted from $couples$. The lists $men$ and $women$ are preserved throughout the execution; the reason behind this particular design decision is to facilitate the writing of predicates in Agda, since, as introduced before, proofs involving the Gale-Shapley algorithm may discuss at the same time the "absolute" preference list of men and women or the \emph{current state} of their preference lists at a certain step of the algorithm. Therefore the current state of a certain man's preference list can be observed either in this or that list given that the man is free or engaged at a certain point during the execution.

We give two extra implementation-specific components: we keep track of the sum of preference lists of men, and at all times provide a proof that this number is in fact equal to the sum if it is computed.

Some helper functions are defined as tools to support the algorithm. They are defined always over pattern matching, typed with the help of Agda's case expansions. Very similar code can be written, for example, in Haskell to perform these operations over lists:

\begin{code}%
\>[0]\AgdaComment{-- Code by @yeputons on Stack Overflow :D}\<%
\\
\>[0]\AgdaFunction{is-≤}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Bool}\<%
\\
\>[0]\AgdaFunction{is-≤}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≤′?}}\AgdaSpace{}%
\AgdaBound{b}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{Dec.yes}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{true}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{Dec.no}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{false}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Helper function to search for an element in a list of natural numbers.}\<%
\\
\>[0]\AgdaFunction{positionInListHelper}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Maybe}\AgdaSpace{}%
\AgdaDatatype{ℕ}\<%
\\
\>[0]\AgdaComment{--searched everywhere but couldn't find it!}\<%
\\
\>[0]\AgdaFunction{positionInListHelper}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{nothing}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{positionInListHelper}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{xs}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{xss}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{compare}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{xs}\<%
\\
\>[0]\AgdaComment{--found man at the tip of the list!}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{equal}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[15]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{just}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[1]\AgdaComment{--accumulate and keep searching...}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[15]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{positionInListHelper}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{xss}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{positionInListHelper}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{xs}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{xss}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{compare}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{xs}\<%
\\
\>[0]\AgdaComment{--found man somewhere in the list}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{equal}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[15]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{just}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaComment{--accumulate and keep searching}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[15]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{positionInListHelper}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{xss}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{positionInList}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Maybe}\AgdaSpace{}%
\AgdaDatatype{ℕ}\<%
\\
\>[0]\AgdaFunction{positionInList}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{ns}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{positionInListHelper}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{ns}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- We usually assume the "husbands" to be the proposing side,}\<%
\\
\>[0]\AgdaComment{-- therefore if women propose instead the pair will}\<%
\\
\>[0]\AgdaComment{-- look like (wife, husband)}\<%
\\
\>[0]\AgdaFunction{getPartner}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{person}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{couples}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Maybe}\AgdaSpace{}%
\AgdaDatatype{ℕ}\<%
\\
\>[0]\AgdaComment{--not married yet and this is the first proposal in the algorithm!}\<%
\\
\>[0]\AgdaFunction{getPartner}\AgdaSpace{}%
\AgdaBound{person}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{nothing}\<%
\\
\>[0]\AgdaFunction{getPartner}\AgdaSpace{}%
\AgdaBound{person}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{compare}\AgdaSpace{}%
\AgdaBound{person}\AgdaSpace{}%
\AgdaBound{w}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{equal}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{just}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaComment{--found your husband!}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{nothing}\AgdaSpace{}%
\AgdaComment{--not married yet}\<%
\\
\>[0]\AgdaFunction{getPartner}\AgdaSpace{}%
\AgdaBound{person}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{c}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{cs}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{compare}\AgdaSpace{}%
\AgdaBound{person}\AgdaSpace{}%
\AgdaBound{w}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{equal}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{just}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaComment{--found your husband!}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{getPartner}\AgdaSpace{}%
\AgdaBound{person}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{c}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{cs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaComment{--keep searching}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Simply extract a preference list from the scheme of indexed lists.}\<%
\\
\>[0]\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\<%
\\
\>[0]\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaBound{person}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaComment{--dummy case}\<%
\\
\>[0]\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaBound{person}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{p}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{preferences}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ps}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{compare}\AgdaSpace{}%
\AgdaBound{person}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{equal}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{preferences}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaBound{person}\AgdaSpace{}%
\AgdaBound{ps}\<%
\\
\>[0]\<%
\end{code}

Three main "operations" are performed during the execution of the algorithm which deserve special attention. In the beginning of the \emph{proposal} step a woman receives a proposal over which she mulls:

\begin{code}%
\>[0]\AgdaComment{-- m is the proposing man}\<%
\\
\>[0]\AgdaComment{-- h is the current husband of the woman}\<%
\\
\>[0]\AgdaComment{-- prefs is the preference list of the woman}\<%
\\
\>[0]\AgdaComment{-- returns true if the woman prefers m over h}\<%
\\
\>[0]\AgdaFunction{propose}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)(}\AgdaBound{h}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)(}\AgdaBound{prefs}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Bool}\<%
\\
\>[0]\AgdaComment{-- Woman compares}\<%
\\
\>[0]\AgdaFunction{propose}%
\>[328I]\AgdaBound{man}\AgdaSpace{}%
\AgdaBound{h}\AgdaSpace{}%
\AgdaBound{preferenceList}\AgdaSpace{}%
\AgdaKeyword{with}\<%
\\
\>[.][@{}l@{}]\<[328I]%
\>[8]\AgdaFunction{positionInList}\AgdaSpace{}%
\AgdaBound{man}\AgdaSpace{}%
\AgdaBound{preferenceList}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaFunction{positionInList}\AgdaSpace{}%
\AgdaBound{h}\AgdaSpace{}%
\AgdaBound{preferenceList}\<%
\\
\>[0]\AgdaComment{--does she prefer the new guy to the current one?}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{just}\AgdaSpace{}%
\AgdaBound{p}%
\>[14]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{just}\AgdaSpace{}%
\AgdaBound{q}%
\>[24]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{is-≤}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaBound{q}\<%
\\
\>[0]\AgdaComment{--shouldn't happen in an ideal world: proposal from an unknown man??}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{just}\AgdaSpace{}%
\AgdaBound{p}%
\>[14]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{nothing}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{false}\<%
\\
\>[0]\AgdaComment{--shouldn't happen in an ideal world: married an unknown man previously??}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{nothing}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{just}\AgdaSpace{}%
\AgdaBound{q}%
\>[24]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{false}\<%
\\
\>[0]\AgdaComment{--shouldn't happen in an ideal world: who are these men??}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{nothing}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{nothing}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{false}\<%
\\
\>[0]\<%
\end{code}

Here it is already possible to notice that, using pattern matching, we are forced to look at every possible case of the execution (since Agda performs termination and pattern matching completeness checkings). But some things just quite don't make sense when examined from the point of view of the Gale-Shapley algorithm: because our implementation must be type-safe, we only \emph{possibly} return a man when we search for him in a woman's preference list. Accordingly, we pattern-match on the possibility that one of the examined men (current fiance or new suitor) doesn't even exist in that woman's list!

In case the woman was previously married and accepts this new proposal, it is important that the new couple "overwrites" the previous couple in which the woman was featured, therefore we simply introduce a "safe" operation for the list update:

\begin{code}%
\>[0]\AgdaComment{-- Safely adding couples : previous marriages are unmade}\<%
\\
\>[0]\AgdaFunction{safeAddNewCouple}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{newCouple}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)(}\AgdaBound{couples}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{safeAddNewCouple}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
\>[0]\AgdaFunction{safeAddNewCouple}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{compare}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaBound{b}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{equal}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
\>[0]\AgdaFunction{safeAddNewCouple}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{c}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{cs}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{compare}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaBound{b}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{equal}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{c}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{cs}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaFunction{safeAddNewCouple}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{c}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{cs}\AgdaSymbol{)}\<%
\end{code}

It is perhaps worth it to stop here and examine what these implementation decisions mean for our later proofs. Since our proofs will be just functions, type-checked and computed down to normal form, the \emph{consistency} of our pattern matching definitions is key to enjoy Agda's computing power (remember: proof-checking is the same activity as type-checking). Suppose we want to prove a simple property of the $safeNewAddCouple$ operation, for example, that it indeed will work for a particular, very easy case:

\begin{code}%
\>[0]\AgdaComment{-- Warm up: let us prove that, if woman 3 is in the list of couples with}\<%
\\
\>[0]\AgdaComment{-- husband 1 and should now be married to husband 2, the new couple will}\<%
\\
\>[0]\AgdaComment{-- indeed be added.}\<%
\\
\>[0]\AgdaFunction{p}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[461I]\AgdaSymbol{(}\AgdaBound{l}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{))(}\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
\>[.][@{}l@{}]\<[461I]%
\>[4]\AgdaFunction{safeAddNewCouple}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{)}\<%
\end{code}

What are the components of this proof, in other words, the parameters to this function? We provide a list, a natural number $a$, a proof that $a = 3$, and must return a proof that the operation returns a new list of couples where man 2 is married to woman 3. First we pattern match on $l$, it has two constructors, [] and \:::. Using Agda's proof assistant capabilities, we will observe that the "goal", that is, the expected type of the function return will contain the $$compare 3 a$$ application. Therefore we must use a \emph{with} construct in our proofs too in order to allow Agda to further reduce down the terms. Depending on the order in which the patterns are opened up, we might end up with different definitions for this function, here is one:

\begin{code}%
\>[0]\AgdaFunction{p}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{compare}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaBound{a}\<%
\\
\>[0]\AgdaFunction{p}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{w}\<%
\\
\>[0]\AgdaFunction{p}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{w}\<%
\\
\>[0]\AgdaFunction{p}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{w}\<%
\\
\>[0]\AgdaFunction{p}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{equal}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{p}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{))))}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{w}\<%
\\
\>[0]\AgdaFunction{p}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{p}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\end{code}

The clauses without a right hand side that can be seen are \emph{absurd patterns}: there is no way we can provide the proof we're hoping for when the number given as the second parameter is not 3 (in other words, \texttt{suc (suc (suc zero))} or \texttt{suc 2}...). If they were possible cases to prove, that is, cases where \emph{there would be a constructor} for the type we hope to achieve, we might for example open up a second \emph{with} construct where in this case only $| w$ was left by Agda, and continue pattern matching and reducing further and further from there until we are able to construct the goal.

In a similar fashion, when the list of engaged men is updated, the previous husband must be removed from it. Ww give two versions for this function, one which simply returns the updated $engagedMen$ list and another one which returns also some extra information (the man who was dumped and goes back to being free). The reasons why are further discussed later in this chapter.

\begin{code}%
\>[0]\AgdaComment{-- Safely adding new engaged men to the list : dumped man is removed}\<%
\\
\>[0]\AgdaFunction{safeAddNewEngagedMan}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[547I]\AgdaSymbol{(}\AgdaBound{newEngagedMan}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[547I]%
\>[23]\AgdaSymbol{(}\AgdaBound{prevFiance}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\<%
\\
%
\>[23]\AgdaSymbol{(}\AgdaBound{prevEngagedMen}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{))}\<%
\\
%
\>[23]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaComment{-- Dummy case: this function is only invoked if a woman is already}\<%
\\
\>[0]\AgdaComment{-- married, so the list of engaged men can not possibly be empty...}\<%
\\
\>[0]\AgdaFunction{safeAddNewEngagedMan}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{prevFiance}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{safeAddNewEngagedMan}%
\>[577I]\AgdaSymbol{(}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{prevFiance}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[577I]%
\>[21]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{compare}\AgdaSpace{}%
\AgdaBound{prevFiance}\AgdaSpace{}%
\AgdaBound{m}\<%
\\
\>[0]\AgdaComment{-- kick him out!}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{equal}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
\>[0]\AgdaComment{-- safe to keep after all}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
\>[0]\AgdaFunction{safeAddNewEngagedMan}%
\>[609I]\AgdaSymbol{(}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{prevFiance}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[609I]%
\>[21]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{compare}\AgdaSpace{}%
\AgdaBound{prevFiance}\AgdaSpace{}%
\AgdaBound{m}\<%
\\
\>[0]\AgdaComment{-- kick him out!}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{equal}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\<%
\\
\>[0]\AgdaComment{-- safe to keep... for now}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[14]\AgdaSymbol{=}%
\>[636I]\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\<%
\\
\>[.][@{}l@{}]\<[636I]%
\>[16]\AgdaFunction{safeAddNewEngagedMan}%
\>[640I]\AgdaSymbol{(}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[640I]%
\>[37]\AgdaBound{prevFiance}\<%
\\
%
\>[37]\AgdaSymbol{(}\AgdaBound{ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- We give an alternative version which doesn't lose information:}\<%
\\
\>[0]\AgdaComment{-- it also returns the dumped man in a pair, or a dummy man}\<%
\\
\>[0]\AgdaComment{-- with an empty list. This helps Agda keep track of the length}\<%
\\
\>[0]\AgdaComment{-- of the preference lists in the matching state}\<%
\\
\>[0]\AgdaFunction{safeAddNewEngagedMan′}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[646I]\AgdaSymbol{(}\AgdaBound{newEngagedMan}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[646I]%
\>[24]\AgdaSymbol{(}\AgdaBound{prevFiance}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\<%
\\
%
\>[24]\AgdaSymbol{(}\AgdaBound{prevEngagedMen}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{))}\<%
\\
%
\>[24]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{safeAddNewEngagedMan′}%
\>[670I]\AgdaSymbol{(}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{prevFiance}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[.][@{}l@{}]\<[670I]%
\>[22]\AgdaSymbol{((}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{0}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{))}\<%
\\
\>[0]\AgdaFunction{safeAddNewEngagedMan′}%
\>[684I]\AgdaSymbol{(}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{prevFiance}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[684I]%
\>[22]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{compare}\AgdaSpace{}%
\AgdaBound{prevFiance}\AgdaSpace{}%
\AgdaBound{m}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{equal}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{))}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(((}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{0}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{))}\<%
\\
\>[0]\AgdaFunction{safeAddNewEngagedMan′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{prevFiance}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[16]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{compare}\AgdaSpace{}%
\AgdaBound{prevFiance}\AgdaSpace{}%
\AgdaBound{m}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{equal}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{))}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[14]\AgdaSymbol{=}%
\>[755I]\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\<%
\\
\>[.][@{}l@{}]\<[755I]%
\>[16]\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{safeAddNewEngagedMan′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{prevFiance}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)))}\<%
\\
%
\>[16]\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[16]\AgdaField{proj₂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{safeAddNewEngagedMan′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{newFiance}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{prevFiance}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{))}\<%
\end{code}

Finally, we are ready to implement a step of the Gale-Shapley algorithm by pattern matching on the matching state. There are two main cases to be distinguished:

\begin{itemize}
    \item There is still a free man with a woman to propose to on his list: we make the proposal, update the state accordingly and return the matching. This case is the third case of the pattern matching in the function below;
    \item There are no more free men: we return the current state as the final (and stable) matching state. That is our base case.
\end{itemize}

We detail them further in the comments:

\begin{code}%
\>[0]\AgdaFunction{step}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{MatchingState}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaRecord{MatchingState}\<%
\\
\>[0]\AgdaComment{-- When there are no more free men, the matching is stable}\<%
\\
\>[0]\AgdaComment{-- and this is the last step.}\<%
\\
\>[0]\AgdaFunction{step}%
\>[779I]\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[.][@{}l@{}]\<[779I]%
\>[5]\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Dummy case : the function shouldn't really be invoked with}\<%
\\
\>[0]\AgdaComment{-- a man with empty preferences. But otherwise Agda would}\<%
\\
\>[0]\AgdaComment{-- question the completeness of our pattern matching.}\<%
\\
\>[0]\AgdaFunction{step}%
\>[795I]\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[.][@{}l@{}]\<[795I]%
\>[5]\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Proposal step}\<%
\\
\>[0]\AgdaFunction{step}%
\>[815I]\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}%
\>[817I]\AgdaSymbol{((}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[817I]%
\>[18]\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[815I]%
\>[5]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{getPartner}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaBound{couples}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- First case: woman w has a husband h, represented by his literal number.}\<%
\\
\>[0]\AgdaComment{-- In this case}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{just}\AgdaSpace{}%
\AgdaBound{h}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{propose}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{h}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaBound{women}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[18]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{true}%
\>[26]\AgdaSymbol{=}%
\>[842I]\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaFunction{freeMenUpdated}\AgdaSpace{}%
\AgdaFunction{engagedMenUpdated}\AgdaSpace{}%
\AgdaBound{women}\<%
\\
\>[.][@{}l@{}]\<[842I]%
\>[28]\AgdaSymbol{(}\AgdaFunction{safeAddNewCouple}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSymbol{)}\<%
\\
%
\>[28]\AgdaSymbol{(}\AgdaFunction{compSumPrefLists}\AgdaSpace{}%
\AgdaFunction{freeMenUpdated}\AgdaSpace{}%
\AgdaFunction{engagedMenUpdated}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[26][@{}l@{\AgdaIndent{0}}]%
\>[27]\AgdaKeyword{where}\<%
\\
\>[27][@{}l@{\AgdaIndent{0}}]%
\>[29]\AgdaFunction{freeMenUpdated}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[29][@{}l@{\AgdaIndent{0}}]%
\>[31]\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{safeAddNewEngagedMan′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{h}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{))}\<%
\\
\>[31][@{}l@{\AgdaIndent{0}}]%
\>[33]\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\<%
\\
%
\>[29]\AgdaFunction{engagedMenUpdated}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[50]\AgdaField{proj₁}\<%
\\
\>[29][@{}l@{\AgdaIndent{0}}]%
\>[33]\AgdaSymbol{(}\AgdaFunction{safeAddNewEngagedMan′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{h}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[18]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{false}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[870I]\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{women}\<%
\\
\>[.][@{}l@{}]\<[870I]%
\>[28]\AgdaBound{couples}\<%
\\
%
\>[28]\AgdaSymbol{(}\AgdaFunction{compSumPrefLists}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
%
\>[28]\AgdaInductiveConstructor{refl}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Second case: woman w didn't have a husband yet: simply must accept proposal}\<%
\\
\>[0]\AgdaFunction{step}%
\>[885I]\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[885I]%
\>[5]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{nothing}\<%
\\
%
\>[5]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{mkState}%
\>[901I]\AgdaBound{men}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{women}\<%
\\
\>[.][@{}l@{}]\<[901I]%
\>[15]\AgdaSymbol{(}\AgdaFunction{safeAddNewCouple}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSymbol{)}\<%
\\
%
\>[15]\AgdaSymbol{(}\AgdaFunction{compSumPrefLists}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\end{code}

In order to calculate a final result we just apply the step function until there are no more free men waiting for a wife. \footnote{We apply a special TERMINATING pragma so Agda's termination checker accepts this function: since the preference lists are hidden inside the matching state structure, it is not immediately obvious that some term is always decreasing in the recursive call. An alternative implementation could be done with the Bove-Capretta method, discussed in Chapter \ref{Chapter5}.}:

\begin{code}%
\>[0]\AgdaSymbol{\{-\#}\AgdaSpace{}%
\AgdaKeyword{TERMINATING}\AgdaSpace{}%
\AgdaSymbol{\#-\}}\<%
\\
\>[0]\AgdaFunction{allSteps}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{MatchingState}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaRecord{MatchingState}\<%
\\
\>[0]\AgdaFunction{allSteps}%
\>[928I]\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaBound{sumPrefLists}\AgdaSpace{}%
\AgdaBound{sumEq}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[.][@{}l@{}]\<[928I]%
\>[9]\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaBound{sumPrefLists}\AgdaSpace{}%
\AgdaBound{sumEq}\<%
\\
\>[0]\AgdaFunction{allSteps}\AgdaSpace{}%
\AgdaBound{m′}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{allSteps}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{step}\AgdaSpace{}%
\AgdaBound{m′}\AgdaSymbol{)}\<%
\end{code}

\section{Proofs on the Gale-Shapley algorithm}

\subsection{Termination}

In order to provide a mathematically relevant proof of termination, we hope to prove a lemma that states that the step function decreases the sum of preference lists. This can be used, as we have seen in Chapter \ref{Chapter2}, in order to construct a proof of total correctness in the domain of Hoare logic. But how can it be done in Agda? Our goal is:

\begin{code}%
\>[0]\AgdaFunction{stepDec}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[950I]\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{MatchingState}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
\>[.][@{}l@{}]\<[950I]%
\>[10]\AgdaFunction{compSumPrefLists}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{MatchingState.freeMen}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{MatchingState.engagedMen}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaOperator{\AgdaFunction{≥′}}\<%
\\
%
\>[10]\AgdaFunction{compSumPrefLists}%
\>[958I]\AgdaSymbol{(}\AgdaField{MatchingState.freeMen}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{step}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[958I]%
\>[27]\AgdaSymbol{(}\AgdaField{MatchingState.engagedMen}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{step}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{))}\<%
\end{code}

Before taking a look at this bigger proof, let us take a look at the techniques used to construct it. Agda's pattern matching and computation is extensively at play here again, as we hope to prove some facts, basically, about natural numbers. Such proofs can be easily constructed in Agda by pattern matching on the arguments of the proof (arguments of the function) further and further until we can reduce to a point where a constructor exists for the type we hope the function to return. Let us warm up with some proofs about properties of the natural numbers:

\begin{code}%
\>[0]\AgdaFunction{leftInv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{a}\<%
\\
\>[0]\AgdaFunction{leftInv}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{rightInv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{a}\<%
\\
\>[0]\AgdaFunction{rightInv}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{rightInv}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rightInv}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\<%
\end{code}

What is the difference between the proofs above? In the first case, if we inspect the type we hope to construct, Agda is able to reduce it from $zero + a$ on the left-hand side to just $a$, since there is a pattern on the plus function definition that says $zero + m = m$. Then we can simply say that for any input, the $refl$ constructor constructs a proof that \begin{math}a = a\end{math}.
For the second case, however, the $zero + m = m$ definition is not enough, since we must construct a proof that suc ($a + 0$) = suc $a$. That almost looks like the definition of our $rightInv$ function, expect for a $suc$ call on both sides. The solution is to define the function recursively: $cong$ adds a parameter to both sides of an equivalence. A similar solution is applied for the next proofs.

\begin{code}%
\>[0]\AgdaFunction{+-zero}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{n}\<%
\\
\>[0]\AgdaFunction{+-zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
\>[0]\AgdaFunction{+-zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
\>[0]\AgdaFunction{+-zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{+-zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaBound{n}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaPrimitive{+}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{0}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{+-identityʳ}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{+-move-zero}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaNumber{0}\<%
\\
\>[0]\AgdaFunction{+-move-zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{+-move-zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{+-move-zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{+-move-zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaBound{n}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaPrimitive{+}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{0}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{+-move-zero}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\<%
\end{code}

These proofs state some similar facts to the proofs before, but they \emph{take in as a parameter} a proof that implies our goal, which we may reuse in our pattern definitions: for example, in +-zero, in the case we get two zeroes as arguments, the definition of the plus function will simply reduce them all to $0 = 0$, which is already the proof we want. It is also interesting to notice that we don't need to give a definition for some of these cases; it will never be true that 0 = (suc k) + 0 or (suc n) = 0 + 0 as we can see in the +-move-zero function, and Agda can discard these cases immediately since there are \emph{no constructors} for them.

Now onto the definition of the $\le$ operator in Agda. There are two constructors for the data type $\le$ (i.e. type of proofs about $\le$): z≤n for the cases involving zero and some other natural number $n$ and s≤s for the cases involving two numbers bigger than zero. By using extensive pattern matching, we can ask Agda to find constructors that match the types we hope to return, in fact, most of the following proofs can be written automatically by asking Agda to search for a solution:

\begin{code}%
\>[0]\AgdaFunction{n≤1+n-plus-zero}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≤}}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{n≤1+n-plus-zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\\
\>[0]\AgdaFunction{n≤1+n-plus-zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{s≤s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n≤1+n-plus-zero}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{n-plus-zero≤1+n+m}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≤}}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{n-plus-zero≤1+n+m}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\\
\>[0]\AgdaFunction{n-plus-zero≤1+n+m}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{s≤s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n-plus-zero≤1+n+m}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{n-plus-zero≤1+n+m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\\
\>[0]\AgdaFunction{n-plus-zero≤1+n+m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{s≤s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n-plus-zero≤1+n+m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{n+m≤n+m+s}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≤}}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaBound{s}\<%
\\
\>[0]\AgdaFunction{n+m≤n+m+s}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\\
\>[0]\AgdaFunction{n+m≤n+m+s}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\\
\>[0]\AgdaFunction{n+m≤n+m+s}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{s≤s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n+m≤n+m+s}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{n+m≤n+m+s}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{s≤s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n+m≤n+m+s}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{))}\<%
\\
\>[0]\AgdaFunction{n+m≤n+m+s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{s≤s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n+m≤n+m+s}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{n+m≤n+m+s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{s≤s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n+m≤n+m+s}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{))}\<%
\\
\>[0]\AgdaFunction{n+m≤n+m+s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{s≤s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n+m≤n+m+s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{n+m≤n+m+s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{s≤s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n+m≤n+m+s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{))}\<%
\end{code}

But how are these proofs being computed down and how does it all type-check? Let us introduce and discuss a new operator: ≤′. This is defined in Agda's standard library as an induction-friendlier alternative to $\le$. Agda also provides some conversion functions that allows us to turn proofs about ≤′ into proofs about $\le$ and vice-versa; they will feature prominently in our code in a moment. The constructors for ≤′ are ≤′-refl and ≤′-step, introduced in the comments of the following code, in which we walk through the process of constructing some of the proofs:

\begin{code}%
\>[0]\<%
\\
\>[0]\AgdaComment{-- These are defined somewhere in the standard library:}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- data \AgdaUnderscore{}≤′\AgdaUnderscore{} (m : ℕ) : ℕ → Set where}\<%
\\
\>[0]\AgdaComment{--  ≤′-refl :                         m ≤′ m}\<%
\\
\>[0]\AgdaComment{--  ≤′-step : ∀ \{n\} (m≤′n : m ≤′ n) → m ≤′ suc n}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- In this interpretation, there are two ways of expressing ≤:}\<%
\\
\>[0]\AgdaComment{-- a number m is always less than or equal to itself;}\<%
\\
\>[0]\AgdaComment{-- or if it's less than or equal to another number n,}\<%
\\
\>[0]\AgdaComment{-- the property will hold also for successors of n.}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- With these tools we can then reconstruct what we had}\<%
\\
\>[0]\AgdaComment{-- previously with the traditional ≤ operator:}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- z≤′n : ∀ \{n\} → zero ≤′ n}\<%
\\
\>[0]\AgdaComment{-- z≤′n \{zero\}  = ≤′-refl}\<%
\\
\>[0]\AgdaComment{-- z≤′n \{suc n\} = ≤′-step z≤′n}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- s≤′s : ∀ \{m n\} → m ≤′ n → suc m ≤′ suc n}\<%
\\
\>[0]\AgdaComment{-- s≤′s ≤′-refl        = ≤′-refl}\<%
\\
\>[0]\AgdaComment{-- s≤′s (≤′-step m≤′n) = ≤′-step (s≤′s m≤′n)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Now let us prove}\<%
\\
\>[0]\AgdaFunction{n≤n+m}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≤′}}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaBound{m}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- This first case just stems from the definition of ≤′-refl.}\<%
\\
\>[0]\AgdaFunction{n≤n+m}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{≤′-refl}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- This second case needs to return a proof of}\<%
\\
\>[0]\AgdaComment{--  suc m ≤′ suc (m + 0).}\<%
\\
\>[0]\AgdaComment{-- This doesn't quite match the definition of ≤′-step,}\<%
\\
\>[0]\AgdaComment{-- so we fallback to ≤ to construct a proof.}\<%
\\
\>[0]\AgdaComment{-- ≤-reflexive says that, if a number is equal to another number,}\<%
\\
\>[0]\AgdaComment{-- then it is also minus than or equal to it.}\<%
\\
\>[0]\AgdaComment{-- So we just have to give a proof that}\<%
\\
\>[0]\AgdaComment{--   suc m ≡ suc (m + 0)}\<%
\\
\>[0]\AgdaComment{-- which we construct in three steps:}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- 1. +-identityʳ m returns a proof that m + 0 ≡ m;}\<%
\\
\>[0]\AgdaComment{-- 2. We flip the arguments with symmetry so we have m ≡ m + 0;}\<%
\\
\>[0]\AgdaComment{-- 3. We apply the suc function on both sides with congruency}\<%
\\
\>[0]\AgdaComment{--   (since a ≡ b → f a ≡ f b), so we have our goal proof.}\<%
\\
\>[0]\AgdaFunction{n≤n+m}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[22]\AgdaFunction{≤⇒≤′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{≤-reflexive}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{cong}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sym}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{+-identityʳ}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{))))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- In the third case, although the goal is simply}\<%
\\
\>[0]\AgdaComment{--  zero ≤′ suc m}\<%
\\
\>[0]\AgdaComment{-- we can observe that our alternative operator does not immediately}\<%
\\
\>[0]\AgdaComment{-- provide a constructor for that as ≤ did; instead we should do it}\<%
\\
\>[0]\AgdaComment{-- constructively with ≤′-step applied to a recursive call. That }\<%
\\
\>[0]\AgdaComment{-- can be deduced from the definition of the z≤′n function above. }\<%
\\
\>[0]\AgdaFunction{n≤n+m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{≤′-step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n≤n+m}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- In the fourth case we conform to the pattern of the  s≤′s function. }\<%
\\
\>[0]\AgdaFunction{n≤n+m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{s≤′s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n≤n+m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Onto some more computationally complicated proofs:}\<%
\\
\>[0]\AgdaFunction{n≤2+m+n}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≤′}}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- The goal for the first case is}\<%
\\
\>[0]\AgdaComment{--   0 ≤′ 2.}\<%
\\
\>[0]\AgdaComment{-- With ≤′-refl we can give a proof that}\<%
\\
\>[0]\AgdaComment{--   0 ≤′ 0}\<%
\\
\>[0]\AgdaComment{-- and then step until the number 2 with ≤′-step.}\<%
\\
\>[0]\AgdaFunction{n≤2+m+n}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{≤′-step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{≤′-step}\AgdaSpace{}%
\AgdaInductiveConstructor{≤′-refl}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Here the goal doesn't reduce down completely,}\<%
\\
\>[0]\AgdaComment{-- so we must construct the type}\<%
\\
\>[0]\AgdaComment{--   suc (n + 0) ≤′ suc (suc (suc (n + 0)))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- But we may notice that if we take (suc (n + 0)) as a}\<%
\\
\>[0]\AgdaComment{-- number n, then our goal is again to prove n ≤ n + 2}\<%
\\
\>[0]\AgdaComment{-- which can be done with the same solution above:}\<%
\\
\>[0]\AgdaFunction{n≤2+m+n}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{≤′-step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{≤′-step}\AgdaSpace{}%
\AgdaInductiveConstructor{≤′-refl}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- For the remaining cases we can do a recursive call while}\<%
\\
\>[0]\AgdaComment{-- beautifully stepping through the natural numbers.}\<%
\\
\>[0]\AgdaFunction{n≤2+m+n}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{≤′-step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n≤2+m+n}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{n≤2+m+n}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{≤′-step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n≤2+m+n}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Here is a similar function which features later in our implementation.}\<%
\\
\>[0]\AgdaFunction{m≤n+r+m}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≤′}}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{r}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{m≤n+r+m}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{z≤′n}\<%
\\
\>[0]\AgdaFunction{m≤n+r+m}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{z≤′n}\<%
\\
\>[0]\AgdaFunction{m≤n+r+m}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{z≤′n}\<%
\\
\>[0]\AgdaFunction{m≤n+r+m}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{z≤′n}\<%
\\
\>[0]\AgdaFunction{m≤n+r+m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{s≤′s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{m≤n+r+m}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{m≤n+r+m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{m≤n+r+m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaBound{r}\<%
\\
\>[0]\AgdaFunction{m≤n+r+m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{s≤′s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{m≤n+r+m}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{m≤n+r+m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{≤′-step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{m≤n+r+m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{))}\<%
\end{code}

Now let us turn this knowledge into action with some warmup proofs about the Gale-Shapley algorithm itself. Again, Agda allows us to express ourselves quite naturally in writing down our postulates; as a first example, let us try to prove that, if a list of men is extended by a certain element (remember a man is represented by a tuple of natural number and list of natural numbers), then the length of the preference lists of that particular list is equal or bigger than by some $n$ than the previous length:

\begin{code}%
\>[0]\AgdaFunction{lengthPrefsExtLemma}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[1413I]\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)(}\AgdaBound{xs}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{))(}\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
\>[.][@{}l@{}]\<[1413I]%
\>[22]\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{xs}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≤′}}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{xs}\AgdaSymbol{)}\<%
\end{code}

This perhaps uninteresting, but clearly true property of our implementation can be simply proven with the use of the same elements we have discussed. Notice that we pattern match only over the function arguments which are interesting in regard to the property we are reasoning over; that is, we go as far as examining the possible constructors of the lists of preferences of men inside the tuples:

\begin{code}%
\>[0]\AgdaFunction{lengthPrefsExtLemma}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{man}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{z≤′n}\<%
\\
\>[0]\AgdaFunction{lengthPrefsExtLemma}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{man}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{n≤′m+n}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{lengthPrefsExtLemma}%
\>[1458I]\AgdaSymbol{(}\AgdaBound{man}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[1458I]%
\>[20]\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSymbol{)}\<%
\\
%
\>[20]\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{lengthPrefsExtLemma}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{man}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSpace{}%
\AgdaBound{n}\<%
\\
\>[0]\AgdaFunction{lengthPrefsExtLemma}%
\>[1476I]\AgdaSymbol{(}\AgdaBound{man}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[1476I]%
\>[20]\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ws}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSymbol{)}\<%
\\
%
\>[20]\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{n≤′m+n}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{ws}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSymbol{)))}\<%
\\
\>[0]\AgdaFunction{lengthPrefsExtLemma}%
\>[1495I]\AgdaSymbol{(}\AgdaBound{man}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[1495I]%
\>[20]\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ws}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSymbol{)}\<%
\\
%
\>[20]\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{m≤n+r+m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{ws}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\<%
\\
\>[0]\<%
\end{code}

Let us attempt a more sophisticated proof. Since the sum of preference lists is calculated by summing up the preferences of free and engaged men, we can state that the sum is at most the same as the sum of preferences in each of the lists at the same time. In this case, our proofs will consist of pairs, constructed by the \_ , \_ operator. In Agda:

\begin{code}%
\>[0]\AgdaFunction{lengthPrefsOneSide}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[1518I]\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{))(}\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
\>[.][@{}l@{}]\<[1518I]%
\>[21]\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaFunction{compSumPrefLists}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[21]\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≤′}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≤′}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- For empty preference lists, we use z≤′n to show that 0 ≤ n for all n. }\<%
\\
\>[0]\AgdaFunction{lengthPrefsOneSide}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{z≤′n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{z≤′n}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- If the man at the head of the some list has an empty preference list,}\<%
\\
\>[0]\AgdaComment{-- we can only be sure the desired property holds by looking at the next one}\<%
\\
\>[0]\AgdaFunction{lengthPrefsOneSide}%
\>[1551I]\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[1551I]%
\>[19]\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[1559I]\AgdaFunction{z≤′n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[.][@{}l@{}]\<[1559I]%
\>[25]\AgdaField{proj₂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lengthPrefsOneSide}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Using reflexivity and symmetry}\<%
\\
\>[0]\AgdaFunction{lengthPrefsOneSide}%
\>[1566I]\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{snd}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[1566I]%
\>[19]\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{z≤′n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{≤⇒≤′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{≤-reflexive}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sym}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{lengthPrefsOneSide}%
\>[1582I]\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
\>[.][@{}l@{}]\<[1582I]%
\>[19]\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaField{proj₁}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lengthPrefsOneSide}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{z≤′n}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Let us use some previously defined proofs!}\<%
\\
\>[0]\AgdaFunction{lengthPrefsOneSide}%
\>[1598I]\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{snd}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[1598I]%
\>[19]\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[1608I]\AgdaFunction{≤⇒≤′}\<%
\\
\>[.][@{}l@{}]\<[1608I]%
\>[28]\AgdaSymbol{(}\AgdaFunction{≤-reflexive}\<%
\\
\>[28][@{}l@{\AgdaIndent{0}}]%
\>[30]\AgdaSymbol{(}\AgdaFunction{+-zero}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{snd}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{))}\<%
\\
%
\>[30]\AgdaSymbol{(}\AgdaFunction{+-move-zero}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{snd}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)))}\<%
\\
%
\>[28]\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)))}\<%
\\
%
\>[28]\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{z≤′n}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{lengthPrefsOneSide}%
\>[1627I]\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[1627I]%
\>[19]\AgdaSymbol{((}\AgdaBound{fst₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
%
\>[19]\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{lengthPrefsOneSide}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{lengthPrefsOneSide}%
\>[1643I]\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[1643I]%
\>[19]\AgdaSymbol{((}\AgdaBound{fst₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{snd₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
%
\>[19]\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaFunction{lengthPrefs}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaBound{freeMen}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaPrimitive{+}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{suc}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaFunction{lengthPrefs}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{((}}\AgdaDottedPattern{\AgdaBound{fst₁}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaBound{snd₁}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaBound{engagedMen}}\AgdaDottedPattern{\AgdaSymbol{)))}}\<%
\\
%
\>[19]\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[1664I]\AgdaField{proj₁}%
\>[1665I]\AgdaSymbol{(}\AgdaFunction{lengthPrefsOneSide}\<%
\\
\>[1665I][@{}l@{\AgdaIndent{0}}]%
\>[35]\AgdaBound{freeMen}\<%
\\
%
\>[35]\AgdaSymbol{((}\AgdaBound{fst₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{snd₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
%
\>[35]\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\<%
\\
\>[35][@{}l@{\AgdaIndent{0}}]%
\>[37]\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{fst₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{snd₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{))}\<%
\\
%
\>[35]\AgdaSymbol{)}\<%
\\
%
\>[35]\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[1664I][@{}l@{\AgdaIndent{0}}]%
\>[27]\AgdaFunction{≤⇒≤′}%
\>[1681I]\AgdaSymbol{(}\AgdaFunction{n≤m+n}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[1681I]%
\>[32]\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{fst₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{snd₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{))))}\<%
\\
\>[0]\AgdaFunction{lengthPrefsOneSide}%
\>[1690I]\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{snd}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[1690I]%
\>[19]\AgdaSymbol{((}\AgdaBound{fst₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
%
\>[19]\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaInductiveConstructor{suc}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaFunction{lengthPrefs}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{((}}\AgdaDottedPattern{\AgdaBound{fst}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaBound{snd}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaBound{freeMen}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaPrimitive{+}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaFunction{lengthPrefs}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaBound{engagedMen}}\AgdaDottedPattern{\AgdaSymbol{))}}\<%
\\
%
\>[19]\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[1711I]\AgdaFunction{≤⇒≤′}\<%
\\
\>[.][@{}l@{}]\<[1711I]%
\>[26]\AgdaSymbol{(}\AgdaInductiveConstructor{s≤s}\<%
\\
\>[26][@{}l@{\AgdaIndent{0}}]%
\>[28]\AgdaSymbol{(}\AgdaFunction{n+m≤n+m+s}\<%
\\
\>[28][@{}l@{\AgdaIndent{0}}]%
\>[30]\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\<%
\\
%
\>[30]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{snd}\AgdaSymbol{)}\<%
\\
%
\>[30]\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{))}\<%
\\
%
\>[26]\AgdaSymbol{)}\<%
\\
%
\>[26]\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[26]\AgdaField{proj₂}%
\>[1715I]\AgdaSymbol{(}\AgdaFunction{lengthPrefsOneSide}\<%
\\
\>[1715I][@{}l@{\AgdaIndent{0}}]%
\>[34]\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{snd}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\<%
\\
%
\>[34]\AgdaBound{engagedMen}\<%
\\
%
\>[34]\AgdaSymbol{((}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{snd}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\<%
\\
\>[34][@{}l@{\AgdaIndent{0}}]%
\>[36]\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)))}\<%
\\
%
\>[34]\AgdaSymbol{(}\AgdaFunction{cong}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{lengthPrefsOneSide}%
\>[1732I]\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{snd}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[1732I]%
\>[19]\AgdaSymbol{((}\AgdaBound{fst₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{snd₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
%
\>[19]\AgdaBound{p}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[1747I]\AgdaFunction{n≤n+m}\<%
\\
\>[1747I][@{}l@{\AgdaIndent{0}}]%
\>[30]\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{fst₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{snd₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)))}\<%
\\
%
\>[30]\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{snd}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)))}\<%
\\
\>[.][@{}l@{}]\<[1747I]%
\>[28]\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[28]\AgdaFunction{≤⇒≤′}\<%
\\
%
\>[28]\AgdaSymbol{(}\AgdaFunction{n≤m+n}\<%
\\
\>[28][@{}l@{\AgdaIndent{0}}]%
\>[30]\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{snd}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{))}\<%
\\
%
\>[30]\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{fst₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{snd₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{))}\<%
\\
%
\>[28]\AgdaSymbol{)}\<%
\\
\>[0]\<%
\end{code}

We hope the previous examples showed how we can put together different pieces of proofs in order to achieve bigger results in Agda. It is worth noticing that many of these proofs can be defined in different ways; whenever possible we tried to use some properties already provided by Agda's standard library, but as we have seen these can all be redefined at any time with some simple mathematical constructs (such as induction, recursion, congruency, symmetry, transitivity and so on).

Finally, we introduce an extra feature of Agda that precisely allowed us to simplify some proofs. Agda constains a semiring solver for natural numbers, which allow us to prove some equalities by simply calling on a solver which reduces things to its normal form \cite{2018UsingSolver}.

\begin{code}%
\>[0]\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat.Solver}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Data.Nat.Solver.+-*-Solver}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{prove}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{solve}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}:=\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{con}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}:+\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}:*\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{:-\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}:-\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Here an alternative language is imported for expressing the}\<%
\\
\>[0]\AgdaComment{-- proof obligations we would like to fulfill:}\<%
\\
\>[0]\AgdaComment{--   the := operator instead of =}\<%
\\
\>[0]\AgdaComment{--   the :+ and :* and so on operators instead of}\<%
\\
\>[0]\AgdaComment{--    their natural number counterparts}\<%
\\
\>[0]\AgdaComment{--   con n instead of n}\<%
\\
\>[0]\AgdaComment{-- and so on...}\<%
\end{code}

We know the following equation to be true for any x natural number:

\begin{code}%
\>[0]\AgdaFunction{lem}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{*}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaNumber{8}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{*}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\end{code}

While expanding the definition application of natural numbers however, we end up with a huge goal in Agda: \textt{x + 4 + (x + 4 + 0) ≡ suc (suc (suc (suc (suc (suc (suc (suc (x + (x + 0)))))))))}. This definitely needs a lot of moving zeros and suc's around, but the ring solver allows for a cleaner definition:

\begin{code}%
\>[0]\AgdaComment{-- The ring solver takes at least three parameters:}\<%
\\
\>[0]\AgdaComment{-- how many variables are involved;}\<%
\\
\>[0]\AgdaComment{-- what is the expression to be solved,}\<%
\\
\>[0]\AgdaComment{--   written down in an alternative syntax}\<%
\\
\>[0]\AgdaComment{-- the refl axiom for wrapping the equality up}\<%
\\
\>[0]\AgdaComment{-- and then the variables to replace in the lambda, if any}\<%
\\
\>[0]\AgdaFunction{lem}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{solve}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x'}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{con}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:*}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x'}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaInductiveConstructor{con}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:=}}\AgdaSpace{}%
\AgdaInductiveConstructor{con}\AgdaSpace{}%
\AgdaNumber{8}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaInductiveConstructor{con}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:*}}\AgdaSpace{}%
\AgdaBound{x'}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\end{code}

Now let us turn into the definition of the stepDec function. In order to make use of Agda's computational capabilities, We must pattern match on proofs about a function by pattern matching in the same way that function does. Let us look at each case individually:

\begin{itemize}
  \item When both the lists of free men and engaged men are empty, our proposition is true since calling the step function will not modify the value of $k$, the sum of preference lists (according to the definition of step). We can in turn prove that k $\le$ k from the definition of ≤′-refl.
  \item When the list of free men is empty but there is at least one man engaged, our proposition is true since calling the step function will not modify the value of $k$ either.
  \item When there is at least one free man but he has no woman to propose to (as pointed before, a dummy case), calling the step function will again not modify the value of $k$.
  \item When there is a free man who has a woman to propose to, we analyse if the woman has a partner or not.
    \begin{itemize}
      \item In case she does, we analyse if the new suitor is preferred to the current husband.
        \begin{itemize}
          \item In case he's not, we must give a proof that the sum of preference lists was decreased by one in this step (since the man discards the woman from the list).
          \item In case he is in fact accepted, we must write down a lemma which calls the functions involved and proves that after calling these functions, the value of $k$ will be equal or decreased. Again, this function should repeat the pattern matching of the involved functions.
        \end{itemize}
      \item In case she was single, she accepts the proposal immediately. We must write down a lemma which shows that, when that man moves from the list of free men to the list of engaged men, the value of $k$ is decreased.
    \end{itemize}
\end{itemize}

We first present the "single woman lemma", constructed with the help of Agda's semiring solver. This lemma is greatly simplified by the fact that the return of the step function for this case immediately discards the woman at the front of the preference list, so our proof obligation for this case is

\begin{code}%
\>[0]\AgdaFunction{singleWomanLemma}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≤′}}\<%
\\
%
\>[2]\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\end{code}

which is true at first glance, if you consider that the elements of the proposition found on the left-hand side are just rearranged on the right-hand side. One would then think that this can be proven with the help of some function that returns a proof that n $\le$ 1 + n; however it is not straight-forward to prove with simple mathematical constructs that the sum on the right-hand side and on the left-hand side are the same. At least, not without a semiring solver: 

\begin{code}%
\>[0]\<%
\\
\>[0]\AgdaComment{-- The definition of subst according to Agda's user manual:}\<%
\\
\>[0]\AgdaComment{-- subst : \{A : Set\} (C : A → Set) \{x y : A\} → x == y → C x → C y}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{singleWomanLemma}%
\>[1848I]\AgdaBound{freeMen}\<%
\\
\>[.][@{}l@{}]\<[1848I]%
\>[17]\AgdaBound{n}\<%
\\
%
\>[17]\AgdaBound{prefs}\<%
\\
%
\>[17]\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{subst}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[17]\AgdaComment{-- We would like to prove something about y. }\<%
\\
\>[17][@{}l@{\AgdaIndent{0}}]%
\>[30]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaSymbol{→}%
\>[1853I]\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\<%
\\
\>[.][@{}l@{}]\<[1853I]%
\>[37]\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
%
\>[37]\AgdaOperator{\AgdaDatatype{≤′}}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{y}\AgdaSymbol{)}\<%
\\
%
\>[17]\AgdaComment{-- We give a proof that x == y}\<%
\\
\>[17][@{}l@{\AgdaIndent{0}}]%
\>[30]\AgdaSymbol{(}\AgdaFunction{solve}%
\>[1863I]\AgdaNumber{3}\<%
\\
\>[.][@{}l@{}]\<[1863I]%
\>[37]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaBound{z}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{y}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaBound{z}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:=}}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaBound{z}\AgdaSymbol{)}\<%
\\
%
\>[37]\AgdaInductiveConstructor{refl}\<%
\\
%
\>[37]\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\<%
\\
%
\>[37]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\<%
\\
%
\>[37]\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
%
\>[30]\AgdaSymbol{)}\<%
\\
%
\>[17]\AgdaComment{-- And another one that the property holds just for x.}\<%
\\
\>[17][@{}l@{\AgdaIndent{0}}]%
\>[30]\AgdaSymbol{(}\AgdaFunction{≤⇒≤′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n≤1+n}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}))}\<%
\\
%
\>[17]\AgdaComment{-- This function will return a proof that it holds for y!}\<%
\end{code}

For the case when a woman says yes to a proposal, thus dumping her current fiance and being paired to new one, we write another lemma in the hope to prove that the function applications involved preserve or decrease the sum of the preference lists. Many cases can be solved by using the semiring solver, since they involve some empty lists and we already know how to construct a (more convoluted proof) that n $\le$ n + 1. Later, however, we must effectively implement the proof of the cases that stem from the comparison of the new suitor to the current husband. Part of this implementation is given below: 

\begin{code}%
\>[0]\AgdaFunction{lemmaProposeTrue}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[1885I]\AgdaSymbol{∀}%
\>[1886I]\AgdaSymbol{(}\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[1886I]%
\>[21]\AgdaSymbol{(}\AgdaBound{formerHusband}\AgdaSpace{}%
\AgdaBound{man}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\<%
\\
%
\>[21]\AgdaSymbol{(}\AgdaBound{prefs}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
\>[.][@{}l@{}]\<[1885I]%
\>[19]\AgdaFunction{length}%
\>[1901I]\AgdaSymbol{(}\AgdaField{proj₂}\<%
\\
\>[1901I][@{}l@{\AgdaIndent{0}}]%
\>[29]\AgdaSymbol{(}\AgdaField{proj₂}\<%
\\
%
\>[29]\AgdaSymbol{(}\AgdaFunction{safeAddNewEngagedMan′}%
\>[1902I]\AgdaSymbol{(}\AgdaBound{man}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\<%
\\
\>[1902I][@{}l@{\AgdaIndent{0}}]%
\>[53]\AgdaBound{formerHusband}\<%
\\
%
\>[53]\AgdaBound{engagedMen}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[1901I]%
\>[26]\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\<%
\\
%
\>[19]\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\<%
\\
%
\>[19]\AgdaFunction{lengthPrefs}%
\>[1908I]\AgdaSymbol{(}\AgdaField{proj₁}\<%
\\
\>[1908I][@{}l@{\AgdaIndent{0}}]%
\>[33]\AgdaSymbol{(}\AgdaFunction{safeAddNewEngagedMan′}%
\>[1909I]\AgdaSymbol{(}\AgdaBound{man}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[1909I]%
\>[56]\AgdaBound{formerHusband}\<%
\\
%
\>[56]\AgdaBound{engagedMen}\AgdaSymbol{))}\<%
\\
%
\>[19]\AgdaOperator{\AgdaDatatype{≤′}}\<%
\\
%
\>[19]\AgdaInductiveConstructor{suc}%
\>[1912I]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\<%
\\
\>[1912I][@{}l@{\AgdaIndent{0}}]%
\>[24]\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\<%
\\
%
\>[24]\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{lemmaProposeTrue}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}%
\>[1920I]\AgdaBound{formerHusband}\AgdaSpace{}%
\AgdaBound{man}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[1920I][@{}l@{\AgdaIndent{0}}]%
\>[30]\AgdaFunction{subst}%
\>[37]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}%
\>[1926I]\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\<%
\\
\>[.][@{}l@{}]\<[1926I]%
\>[44]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{)}\<%
\\
%
\>[44]\AgdaOperator{\AgdaDatatype{≤′}}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
\>[30][@{}l@{\AgdaIndent{0}}]%
\>[32]\AgdaSymbol{(}\AgdaFunction{solve}%
\>[1934I]\AgdaNumber{2}\<%
\\
\>[.][@{}l@{}]\<[1934I]%
\>[39]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{y}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaInductiveConstructor{con}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:=}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{y}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaInductiveConstructor{con}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{))}\<%
\\
%
\>[39]\AgdaInductiveConstructor{refl}\<%
\\
%
\>[39]\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\<%
\\
%
\>[39]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\<%
\\
%
\>[32]\AgdaSymbol{)}\<%
\\
%
\>[32]\AgdaSymbol{(}\AgdaFunction{≤⇒≤′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n≤1+n}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{lemmaProposeTrue}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{formerHusband}\AgdaSpace{}%
\AgdaBound{man}\AgdaSpace{}%
\AgdaBound{prefs}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{compare}\AgdaSpace{}%
\AgdaBound{formerHusband}\AgdaSpace{}%
\AgdaBound{m}\<%
\\
\>[0]\AgdaFunction{lemmaProposeTrue}%
\>[1967I]\AgdaBound{freeMen}\<%
\\
\>[.][@{}l@{}]\<[1967I]%
\>[17]\AgdaSymbol{((}\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaInductiveConstructor{suc}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaBound{formerHusband}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaPrimitive{+}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaBound{k}}\AgdaDottedPattern{\AgdaSymbol{))}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
%
\>[17]\AgdaBound{formerHusband}\<%
\\
%
\>[17]\AgdaBound{man}\<%
\\
%
\>[17]\AgdaBound{prefs}\AgdaSpace{}%
\AgdaSymbol{|}%
\>[1976I]\AgdaInductiveConstructor{less}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaBound{formerHusband}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[.][@{}l@{}]\<[1976I]%
\>[25]\AgdaFunction{subst}\<%
\\
\>[25][@{}l@{\AgdaIndent{0}}]%
\>[27]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}%
\>[1982I]\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\<%
\\
\>[.][@{}l@{}]\<[1982I]%
\>[34]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{))}\<%
\\
\>[27][@{}l@{\AgdaIndent{0}}]%
\>[29]\AgdaOperator{\AgdaDatatype{≤′}}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
%
\>[27]\AgdaSymbol{(}\AgdaFunction{solve}\AgdaSpace{}%
\AgdaNumber{3}\<%
\\
\>[27][@{}l@{\AgdaIndent{0}}]%
\>[29]\AgdaSymbol{(λ}%
\>[1994I]\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaBound{z}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{y}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{z}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaInductiveConstructor{con}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[1994I]%
\>[32]\AgdaOperator{\AgdaFunction{:=}}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{z}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaInductiveConstructor{con}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{))}\<%
\\
%
\>[29]\AgdaInductiveConstructor{refl}\<%
\\
%
\>[29]\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\<%
\\
%
\>[29]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\<%
\\
%
\>[29]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{))}\<%
\\
%
\>[27]\AgdaSymbol{(}\AgdaFunction{≤⇒≤′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n≤1+n}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{lemmaProposeTrue}%
\>[2019I]\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaBound{m}}\AgdaSpace{}%
\AgdaBound{man}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{equal}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaBound{m}}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[.][@{}l@{}]\<[2019I]%
\>[17]\AgdaFunction{subst}\<%
\\
\>[17][@{}l@{\AgdaIndent{0}}]%
\>[19]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}%
\>[2034I]\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\<%
\\
\>[.][@{}l@{}]\<[2034I]%
\>[26]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≤′}}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
%
\>[19]\AgdaSymbol{(}\AgdaFunction{solve}\AgdaSpace{}%
\AgdaNumber{3}\<%
\\
\>[19][@{}l@{\AgdaIndent{0}}]%
\>[21]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaBound{z}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{z}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaInductiveConstructor{con}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{)}\<%
\\
\>[21][@{}l@{\AgdaIndent{0}}]%
\>[23]\AgdaOperator{\AgdaFunction{:=}}\AgdaSpace{}%
\AgdaBound{z}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaInductiveConstructor{con}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{))}\<%
\\
%
\>[21]\AgdaInductiveConstructor{refl}\<%
\\
%
\>[21]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\<%
\\
%
\>[21]\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\<%
\\
%
\>[21]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\<%
\\
%
\>[19]\AgdaSymbol{)}\<%
\\
%
\>[19]\AgdaSymbol{(}\AgdaFunction{≤⇒≤′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n≤1+n}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{lemmaProposeTrue}%
\>[2072I]\AgdaBound{freeMen}\<%
\\
\>[.][@{}l@{}]\<[2072I]%
\>[17]\AgdaSymbol{((}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
%
\>[17]\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaInductiveConstructor{suc}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaBound{m}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaPrimitive{+}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaBound{k}}\AgdaDottedPattern{\AgdaSymbol{))}}\AgdaSpace{}%
\AgdaBound{man}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{greater}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaBound{m}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
%
\>[17]\AgdaFunction{subst}\<%
\\
\>[17][@{}l@{\AgdaIndent{0}}]%
\>[19]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\<%
\\
\>[19][@{}l@{\AgdaIndent{0}}]%
\>[21]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{))}\<%
\\
%
\>[21]\AgdaOperator{\AgdaDatatype{≤′}}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
%
\>[19]\AgdaSymbol{(}\AgdaFunction{solve}%
\>[2100I]\AgdaNumber{3}\<%
\\
\>[.][@{}l@{}]\<[2100I]%
\>[26]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaBound{z}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{y}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{z}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaInductiveConstructor{con}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{))}\<%
\\
\>[26][@{}l@{\AgdaIndent{0}}]%
\>[28]\AgdaOperator{\AgdaFunction{:=}}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{z}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaInductiveConstructor{con}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{))}\<%
\\
%
\>[26]\AgdaInductiveConstructor{refl}\<%
\\
%
\>[26]\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\<%
\\
%
\>[26]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\<%
\\
%
\>[26]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\<%
\\
%
\>[19]\AgdaSymbol{)}\<%
\\
%
\>[19]\AgdaSymbol{(}\AgdaFunction{≤⇒≤′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n≤1+n}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{lemmaProposeTrue}%
\>[2126I]\AgdaBound{freeMen}\<%
\\
\>[.][@{}l@{}]\<[2126I]%
\>[17]\AgdaSymbol{((}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
%
\>[17]\AgdaBound{formerHusband}\<%
\\
%
\>[17]\AgdaBound{man}\<%
\\
%
\>[17]\AgdaBound{prefs}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{compare}\AgdaSpace{}%
\AgdaBound{formerHusband}\AgdaSpace{}%
\AgdaBound{m}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{lemmaProposeTrue}%
\>[2137I]\AgdaBound{freeMen}\<%
\\
\>[.][@{}l@{}]\<[2137I]%
\>[17]\AgdaSymbol{((}\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaInductiveConstructor{suc}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaBound{formerHusband}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaPrimitive{+}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaBound{k}}\AgdaDottedPattern{\AgdaSymbol{))}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
%
\>[17]\AgdaBound{formerHusband}\<%
\\
%
\>[17]\AgdaBound{man}\<%
\\
%
\>[17]\AgdaBound{prefs}%
\>[2147I]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{less}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaBound{formerHusband}}\AgdaSpace{}%
\AgdaBound{k}\<%
\\
\>[.][@{}l@{}]\<[2147I]%
\>[23]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{safeAddNewEngagedMan′}%
\>[2152I]\AgdaSymbol{(}\AgdaBound{man}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[2152I]%
\>[50]\AgdaBound{formerHusband}\<%
\\
%
\>[50]\AgdaSymbol{(}\AgdaBound{ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- This is yet to be proven, but if it is, our lemma is sound.}\<%
\\
\>[0]\AgdaFunction{lemmaProposeTrue}%
\>[2157I]\AgdaBound{freeMen}\<%
\\
\>[.][@{}l@{}]\<[2157I]%
\>[17]\AgdaSymbol{((}\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaInductiveConstructor{suc}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaBound{formerHusband}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaPrimitive{+}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaBound{k}}\AgdaDottedPattern{\AgdaSymbol{))}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
%
\>[17]\AgdaBound{formerHusband}\<%
\\
%
\>[17]\AgdaBound{man}\<%
\\
%
\>[17]\AgdaBound{prefs}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{less}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaBound{formerHusband}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{updatedEngagedMen}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{extraInfo}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{\{!!\}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- The equal case can, of course, be solved with the semiring solver.}\<%
\\
\>[0]\AgdaFunction{lemmaProposeTrue}%
\>[2177I]\AgdaBound{freeMen}\<%
\\
\>[.][@{}l@{}]\<[2177I]%
\>[17]\AgdaSymbol{((}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\<%
\\
%
\>[17]\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaBound{m}}\<%
\\
%
\>[17]\AgdaBound{man}\<%
\\
%
\>[17]\AgdaBound{prefs}\AgdaSpace{}%
\AgdaSymbol{|}%
\>[2185I]\AgdaInductiveConstructor{equal}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaBound{m}}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[.][@{}l@{}]\<[2185I]%
\>[25]\AgdaFunction{subst}\<%
\\
\>[25][@{}l@{\AgdaIndent{0}}]%
\>[27]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}%
\>[2190I]\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\<%
\\
\>[.][@{}l@{}]\<[2190I]%
\>[34]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{))}\<%
\\
%
\>[34]\AgdaOperator{\AgdaDatatype{≤′}}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
%
\>[27]\AgdaSymbol{(}\AgdaFunction{solve}%
\>[2206I]\AgdaNumber{5}\<%
\\
\>[.][@{}l@{}]\<[2206I]%
\>[34]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaBound{z}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
\>[34][@{}l@{\AgdaIndent{0}}]%
\>[36]\AgdaBound{u}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{w}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{y}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaBound{z}\AgdaSymbol{))}\<%
\\
%
\>[36]\AgdaOperator{\AgdaFunction{:=}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{u}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{y}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{:+}}\AgdaSpace{}%
\AgdaBound{z}\AgdaSymbol{)))}\<%
\\
%
\>[34]\AgdaInductiveConstructor{refl}\<%
\\
%
\>[34]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\<%
\\
%
\>[34]\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\<%
\\
%
\>[34]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\<%
\\
%
\>[34]\AgdaSymbol{(}\AgdaFunction{length}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSymbol{))}\<%
\\
%
\>[34]\AgdaSymbol{(}\AgdaFunction{lengthPrefs}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{))}\<%
\\
%
\>[27]\AgdaSymbol{(}\AgdaFunction{≤⇒≤′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n≤1+n}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- This is yet to be proven, but if it is, our lemma is sound.}\<%
\\
\>[0]\AgdaFunction{lemmaProposeTrue}\AgdaSpace{}%
\AgdaBound{freeMen}%
\>[2239I]\AgdaSymbol{((}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaInductiveConstructor{suc}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaBound{m}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaPrimitive{+}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaBound{k}}\AgdaDottedPattern{\AgdaSymbol{))}}\AgdaSpace{}%
\AgdaBound{man}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSpace{}%
\AgdaSymbol{|}\<%
\\
\>[.][@{}l@{}]\<[2239I]%
\>[25]\AgdaInductiveConstructor{greater}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaBound{m}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{\{!!\}}\<%
\\
\>[0]\<%
\end{code}

With these different pieces in place we can write down the $stepDec$ function:

\begin{code}%
\>[0]\AgdaFunction{stepDec}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{≤′-refl}\<%
\\
\>[0]\AgdaFunction{stepDec}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{man}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{≤′-refl}\<%
\\
\>[0]\AgdaFunction{stepDec}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{man}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{≤′-refl}\<%
\\
\>[0]\AgdaFunction{stepDec}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{man}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{getPartner}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaBound{couples}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[16]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{just}\AgdaSpace{}%
\AgdaBound{h}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{propose}\AgdaSpace{}%
\AgdaBound{man}\AgdaSpace{}%
\AgdaBound{h}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaBound{women}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[16]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{true}%
\>[24]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{lemmaProposeTrue}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{h}\AgdaSpace{}%
\AgdaBound{man}\AgdaSpace{}%
\AgdaBound{prefs}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[16]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{false}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{≤⇒≤′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n≤1+n}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\<%
\\
\>[0]\AgdaFunction{stepDec}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{nothing}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{singleWomanLemma}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{prefs}\AgdaSpace{}%
\AgdaBound{engagedMen}\<%
\end{code}

\subsection{Correctness}

We now proceed to discuss the correctness of the deferred acceptance algorithm. Again, we start by giving some definitions and a few helper functions.

\begin{code}%
\>[0]\AgdaComment{-- The type of elements that belong to a list.}\<%
\\
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}∈\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSymbol{\}(}\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{now}%
\>[8]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{as}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{as}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{a'}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}\{}\AgdaBound{as}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaBound{as}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{a'}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{as}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Bigger than comparison for Maybe ℕ-typed elements. }\<%
\\
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}>just\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Maybe}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Maybe}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{>}}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{just}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{>just}}\AgdaSpace{}%
\AgdaInductiveConstructor{just}\AgdaSpace{}%
\AgdaBound{n}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Helper for the condition of stability:}\<%
\\
\>[0]\AgdaComment{-- a person is better than another one}\<%
\\
\>[0]\AgdaComment{-- in a preference list if it appears earlier in it.}\<%
\\
\>[0]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}≻[\AgdaUnderscore{}]\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\<%
\\
\>[0]\AgdaBound{person}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≻[}}\AgdaSpace{}%
\AgdaBound{list}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{]}}\AgdaSpace{}%
\AgdaBound{person₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{positionInList}\AgdaSpace{}%
\AgdaBound{person₂}\AgdaSpace{}%
\AgdaBound{list}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{>just}}\AgdaSpace{}%
\AgdaFunction{positionInList}\AgdaSpace{}%
\AgdaBound{person}\AgdaSpace{}%
\AgdaBound{list}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Given a man and a woman and their preferences,}\<%
\\
\>[0]\AgdaComment{-- the condition of stability is satisfied if}\<%
\\
\>[0]\AgdaComment{-- no other m' and w' are not better positioned}\<%
\\
\>[0]\AgdaComment{-- in their preference lists than their partners.}\<%
\\
\>[0]\AgdaFunction{conditionOfStabilitySatisfied}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[2440I]\AgdaSymbol{(}\AgdaBound{c₁}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[2440I]%
\>[32]\AgdaSymbol{(}\AgdaBound{c₂}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{))}\<%
\\
%
\>[32]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\<%
\\
\>[0]\AgdaFunction{conditionOfStabilitySatisfied}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsW}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{m'}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsM'}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{w'}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{prefsW'}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{¬}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaBound{w'}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≻[}}\AgdaSpace{}%
\AgdaBound{prefsM}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{]}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}%
\>[31]\AgdaSymbol{(}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≻[}}\AgdaSpace{}%
\AgdaBound{prefsW'}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{]}}\AgdaSpace{}%
\AgdaBound{m'}\AgdaSpace{}%
\AgdaSymbol{)))}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{×}}\<%
\\
%
\>[2]\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{¬}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{w}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≻[}}\AgdaSpace{}%
\AgdaBound{prefsM'}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{]}}\AgdaSpace{}%
\AgdaBound{w'}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m'}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≻[}}\AgdaSpace{}%
\AgdaBound{prefsW}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{]}}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- A matching is stable if the condition of stability is satisfied}\<%
\\
\>[0]\AgdaComment{-- for every pair of man and woman not married.}\<%
\\
\>[0]\AgdaFunction{is-stable-matching}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{MatchingState}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\<%
\\
\>[0]\AgdaFunction{is-stable-matching}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{(}\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaSymbol{(}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaSymbol{(}\AgdaBound{c₁}%
\>[2521I]\AgdaBound{c₂}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{¬}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{c₁}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
\>[.][@{}l@{}]\<[2521I]%
\>[10]\AgdaFunction{conditionOfStabilitySatisfied}\<%
\\
%
\>[10]\AgdaSymbol{(}%
\>[2540I]\AgdaSymbol{(}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{men}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[.][@{}l@{}]\<[2540I]%
\>[12]\AgdaSymbol{(}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{women}\AgdaSymbol{))}\<%
\\
%
\>[10]\AgdaSymbol{(}%
\>[2556I]\AgdaSymbol{(}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{men}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[.][@{}l@{}]\<[2556I]%
\>[12]\AgdaSymbol{(}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{women}\AgdaSymbol{)))}\<%
\end{code}

Now let us examine some examples to make use of these definitions. We look at the two cases from Gale and Shapley's original paper, one where we have an uncomplicated setup for which the deferred acceptance algorithm gives every man the first possible choice of woman, and another where there is in fact only one possible stable set of marriages and the algorithm takes a longer number of steps to arrive to its final state.

\begin{code}%
\>[0]\AgdaComment{-- List of preferences of men and women from the}\<%
\\
\>[0]\AgdaComment{-- Gale-Shapley canonical example}\<%
\\
\>[0]\AgdaFunction{listMen}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{listMen}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{listWomen}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{listWomen}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Extra example : men and women have only}\<%
\\
\>[0]\AgdaComment{-- one possible stable set of marriages!}\<%
\\
\>[0]\AgdaComment{-- What could happen...?}\<%
\\
\>[0]\AgdaFunction{listDifficultMen}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{listDifficultMen}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[2663I]\AgdaSymbol{(}\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\<%
\\
\>[.][@{}l@{}]\<[2663I]%
\>[19]\AgdaSymbol{(}\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\<%
\\
%
\>[19]\AgdaSymbol{(}\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\<%
\\
%
\>[19]\AgdaSymbol{(}\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{listDifficultWomen}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{listDifficultWomen}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[2724I]\AgdaSymbol{(}\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\<%
\\
\>[.][@{}l@{}]\<[2724I]%
\>[21]\AgdaSymbol{(}\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\<%
\\
%
\>[21]\AgdaSymbol{(}\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\<%
\\
%
\>[21]\AgdaSymbol{(}\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\end{code}

We can check that our implementation reaches the result promised by Gale and Shapley by simply constructing the proof that some applications of the step function reach the expected end state:

\begin{code}%
\>[0]\AgdaFunction{exStart}\AgdaSpace{}%
\AgdaFunction{exEnd}\AgdaSpace{}%
\AgdaFunction{exEndExpected}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{MatchingState}\<%
\\
\>[0]\AgdaFunction{exStart}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaFunction{listMen}\AgdaSpace{}%
\AgdaFunction{listMen}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaFunction{listWomen}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaNumber{9}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaComment{-- Gale and Shapley tell us that, for the first simple example, each men}\<%
\\
\>[0]\AgdaComment{-- gets his first woman from the list as a wife and there are no}\<%
\\
\>[0]\AgdaComment{-- conflicts amongst them. So we expect the following end state:}\<%
\\
\>[0]\AgdaFunction{exEndExpected}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{mkState}%
\>[2793I]\AgdaFunction{listMen}\<%
\\
\>[.][@{}l@{}]\<[2793I]%
\>[24]\AgdaInductiveConstructor{[]}\<%
\\
%
\>[24]\AgdaSymbol{((}\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\<%
\\
\>[24][@{}l@{\AgdaIndent{0}}]%
\>[25]\AgdaSymbol{((}\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\<%
\\
\>[25][@{}l@{\AgdaIndent{0}}]%
\>[26]\AgdaSymbol{(}\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{))}\<%
\\
%
\>[24]\AgdaFunction{listWomen}\<%
\\
%
\>[24]\AgdaSymbol{((}\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
%
\>[24]\AgdaNumber{6}\<%
\\
%
\>[24]\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{exEnd}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{step}\AgdaSpace{}%
\AgdaFunction{exStart}\AgdaSymbol{)))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{resultIsWhatWeExpected}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{exEnd}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaFunction{exEndExpected}\<%
\\
\>[0]\AgdaFunction{resultIsWhatWeExpected}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{ex2Start}\AgdaSpace{}%
\AgdaFunction{ex2End}\AgdaSpace{}%
\AgdaFunction{ex2EndExpected}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{MatchingState}\<%
\\
\>[0]\AgdaFunction{ex2Start}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaFunction{listDifficultMen}\AgdaSpace{}%
\AgdaFunction{listDifficultMen}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaFunction{listDifficultWomen}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaNumber{16}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaComment{-- A second, harder example is given where}\<%
\\
\>[0]\AgdaComment{-- there is only one possible stable set of marriages.}\<%
\\
\>[0]\AgdaFunction{ex2EndExpected}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{mkState}%
\>[2855I]\AgdaFunction{listDifficultMen}\<%
\\
\>[2855I][@{}l@{\AgdaIndent{0}}]%
\>[27]\AgdaInductiveConstructor{[]}\<%
\\
%
\>[27]\AgdaSymbol{((}\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\<%
\\
\>[27][@{}l@{\AgdaIndent{0}}]%
\>[29]\AgdaSymbol{(}\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
%
\>[27]\AgdaFunction{listDifficultWomen}\<%
\\
%
\>[27]\AgdaSymbol{(((}\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{))}\<%
\\
%
\>[27]\AgdaNumber{7}\<%
\\
%
\>[27]\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{ex2End}%
\>[8]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{step}%
\>[2907I]\AgdaSymbol{(}\AgdaFunction{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{step}\<%
\\
\>[.][@{}l@{}]\<[2907I]%
\>[15]\AgdaSymbol{(}\AgdaFunction{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{step}\AgdaSpace{}%
\AgdaFunction{ex2Start}\AgdaSymbol{))))))))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{result2IsWhatWeExpected}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{ex2End}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaFunction{ex2EndExpected}\<%
\\
\>[0]\AgdaFunction{result2IsWhatWeExpected}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\<%
\end{code}

Expectably, these applications are precisely the total applications of step if we utilize our previously defined allSteps function:

\begin{code}%
\>[0]\AgdaFunction{numberOfStepsIsCorrect}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{exEnd}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaFunction{allSteps}\AgdaSpace{}%
\AgdaFunction{exStart}\<%
\\
\>[0]\AgdaFunction{numberOfStepsIsCorrect}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{numberOfStepsIsCorrectAgain}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{ex2End}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaFunction{allSteps}\AgdaSpace{}%
\AgdaFunction{ex2Start}\<%
\\
\>[0]\AgdaFunction{numberOfStepsIsCorrectAgain}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\end{code}

Expressing such properties in the code also calls our attention to later inconsistencies during coding: in case we do some modification that breaks the step function, the type checking will fail for these small proofs of equality as if a test failed. Here, we are still on the same level as a unit tester running a test suite in their code, but we will soon take the leap to the next one.

What about showing that the matching returned by the deferred acceptance algorithm is stable? Let's do it for $exEnd$:

\begin{code}%
\>[0]\AgdaComment{-- What does it mean to be stable?}\<%
\\
\>[0]\AgdaFunction{matchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{c₁}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}%
\>[39]\AgdaSymbol{→}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaComment{-- Given any two couples in exEnd}\<%
\\
%
\>[6]\AgdaBound{c₁}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaField{MatchingState.couples}\AgdaSpace{}%
\AgdaFunction{exEnd}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[6]\AgdaBound{c₂}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaField{MatchingState.couples}\AgdaSpace{}%
\AgdaFunction{exEnd}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[6]\AgdaComment{-- If it's not the same couple}\<%
\\
%
\>[6]\AgdaOperator{\AgdaFunction{¬}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{c₁}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[6]\AgdaComment{-- Then the condition of stability is satisfied for them }\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[7]\AgdaFunction{conditionOfStabilitySatisfied}\<%
\\
%
\>[6]\AgdaSymbol{(((}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{(}\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{MatchingState.men}\AgdaSpace{}%
\AgdaFunction{exEnd}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{((}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{(}\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{MatchingState.women}\AgdaSpace{}%
\AgdaFunction{exEnd}\AgdaSymbol{))))}\<%
\\
%
\>[6]\AgdaSymbol{(((}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{(}\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{MatchingState.men}\AgdaSpace{}%
\AgdaFunction{exEnd}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{((}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{(}\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{MatchingState.women}\AgdaSpace{}%
\AgdaFunction{exEnd}\AgdaSymbol{))))}\<%
\end{code}

The proof for a particular case can be done by exhaustive pattern matching on the constructors of the elements; in particular, we pattern match on the proofs that the couples are part of the list of couples. There are three different possibilities for this pattern matching:

\begin{itemize}
  \item We are looking at the case where $c_1$ and $c_2$ are in fact the same couple: we use the proof that $\neg (c_1 \== c_2)$ to eliminate this impossible case.
  \item The pattern is simply not possible (the combinations with less than 2 couples), so we write them out as absurd patterns. 
  \item We are looking at two different couples indeed, and must provide a proof that at least one person prefers their partner to the possibility in the other couple (since the condition of stability is written down as a pair, or cartesian product, only one suffices). Since our comparison helper function for persons in preference lists, $\succ$, is total and , we use our helper >from> constructor that compares Maybe-N typed elements to show that this is true for the side of the men in every one of these cases\footnote{Remember every man gets the best possible wife, so surely his wife is preferred to any alternative.}, and the second part of the proof can be skipped with an underline marker since it is sufficient for the condition of stability that at least one side fullfills it.
\end{itemize}

\begin{code}%
\>[0]\AgdaFunction{matchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[2982I]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[2982I]%
\>[24]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
%
\>[24]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{⊥-elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{p}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{⊥-elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{p}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{matchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3011I]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[3011I]%
\>[24]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
%
\>[24]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[3028I]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[3028I][@{}l@{\AgdaIndent{0}}]%
\>[29]\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaFunction{matchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3044I]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[3044I]%
\>[24]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
%
\>[24]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[3058I]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[3058I][@{}l@{\AgdaIndent{0}}]%
\>[29]\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaFunction{matchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3074I]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[3074I]%
\>[24]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\<%
\\
%
\>[24]\AgdaBound{p}\<%
\\
\>[0]\AgdaFunction{matchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3089I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[3089I]%
\>[24]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
%
\>[24]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[3106I]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[3106I][@{}l@{\AgdaIndent{0}}]%
\>[29]\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaFunction{matchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3122I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[3122I]%
\>[24]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
%
\>[24]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{⊥-elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{p}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{matchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3141I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[3141I]%
\>[24]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
%
\>[24]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[3152I]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[3152I][@{}l@{\AgdaIndent{0}}]%
\>[29]\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaFunction{matchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3168I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[3168I]%
\>[24]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\<%
\\
\>[0]\AgdaFunction{matchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3180I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
\>[.][@{}l@{}]\<[3180I]%
\>[24]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
%
\>[24]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[3194I]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[3194I][@{}l@{\AgdaIndent{0}}]%
\>[29]\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaFunction{matchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3210I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
\>[.][@{}l@{}]\<[3210I]%
\>[24]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
%
\>[24]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[3221I]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[3221I][@{}l@{\AgdaIndent{0}}]%
\>[29]\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaFunction{matchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3237I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
\>[.][@{}l@{}]\<[3237I]%
\>[24]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
%
\>[24]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{⊥-elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{p}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{matchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3250I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
\>[.][@{}l@{}]\<[3250I]%
\>[24]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\<%
\\
\>[0]\AgdaFunction{matchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\end{code}

So, again, what does it mean for a matching to be stable according to our definition? To have an empty list of free men... which we can prove for $exEnd$ using the refl axiom; and to satisfy the condition of stability for every two couples... which is the definition we have just provided of matchIsStableHelper. We can then give a proof that $exEnd$ is indeed a stable matching: 

\begin{code}%
\>[0]\AgdaFunction{matchIsStable}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{is-stable-matching}\AgdaSpace{}%
\AgdaFunction{exEnd}\<%
\\
\>[0]\AgdaFunction{matchIsStable}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{matchIsStableHelper}\<%
\end{code}

Let us now take that promised leap onto the next level. We postulate that, indeed, any matching returned by the Gale-Shapley algorithm is stable:

\begin{code}%
\>[0]\AgdaKeyword{postulate}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaPostulate{pAnyMatchIsStable}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{m'}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{MatchingState}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{m'}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaFunction{allSteps}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[19]\AgdaFunction{is-stable-matching}\AgdaSpace{}%
\AgdaBound{m'}\<%
\end{code}

We go about trying to prove it by providing similar elements to the ones used in the proof of the particular case before.

\begin{code}%
\>[0]\AgdaFunction{anyMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{MatchingState}\AgdaSymbol{)(}\AgdaBound{c₁}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}%
\>[61]\AgdaSymbol{→}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaComment{-- Given any two couples in a matching}\<%
\\
%
\>[6]\AgdaBound{c₁}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaField{MatchingState.couples}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[6]\AgdaBound{c₂}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaField{MatchingState.couples}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[6]\AgdaComment{-- If it's not the same couple}\<%
\\
%
\>[6]\AgdaOperator{\AgdaFunction{¬}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{c₁}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[6]\AgdaComment{-- When there are no more free men}\<%
\\
%
\>[6]\AgdaField{MatchingState.freeMen}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[6]\AgdaComment{-- Then the condition of stability is satisfied }\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[7]\AgdaFunction{conditionOfStabilitySatisfied}\<%
\\
%
\>[6]\AgdaSymbol{(((}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{(}\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{MatchingState.men}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{((}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{(}\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{MatchingState.women}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{))))}\<%
\\
%
\>[6]\AgdaSymbol{(((}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{(}\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{MatchingState.men}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{((}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{(}\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{MatchingState.women}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{))))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{-- Absurd pattern: if there are no couples at all}\<%
\\
\>[0]\AgdaComment{-- we can't possibly think about this!}\<%
\\
\>[0]\AgdaFunction{anyMatchIsStableHelper}%
\>[3336I]\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\<%
\\
\>[.][@{}l@{}]\<[3336I]%
\>[23]\AgdaSymbol{(}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{snd}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{fst₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{snd₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaBound{p₂}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{anyMatchIsStableHelper}%
\>[3353I]\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}%
\>[3354I]\AgdaBound{men}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[3354I]%
\>[32]\AgdaBound{sumPrefLists}\AgdaSpace{}%
\AgdaBound{sumEq}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[3353I]%
\>[23]\AgdaSymbol{(}\AgdaBound{fst}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{snd}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{fst₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{snd₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{p₁}\AgdaSpace{}%
\AgdaBound{p₂}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{\{!!\}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\{!!\}}\<%
\\
\>[0]\AgdaComment{-- Absurd pattern: if there are still some free men}\<%
\\
\>[0]\AgdaComment{-- we can't possibly think about this either!}\<%
\\
\>[0]\AgdaFunction{anyMatchIsStableHelper}%
\>[3375I]\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\<%
\\
\>[.][@{}l@{}]\<[3375I]%
\>[23]\AgdaBound{c₁}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSpace{}%
\AgdaBound{p₁}\AgdaSpace{}%
\AgdaBound{p₂}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{anyMatchIsStable}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[3391I]\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{m'}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{MatchingState}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{m'}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaFunction{allSteps}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
\>[.][@{}l@{}]\<[3391I]%
\>[19]\AgdaFunction{is-stable-matching}\AgdaSpace{}%
\AgdaBound{m'}\<%
\\
\>[0]\AgdaFunction{anyMatchIsStable}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{m′}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{\{!!\}}\<%
\end{code}

\subsection{Optimality}

We have logically reasoned in Section \ref{output-is-optimal} that, given every possible stable matching, no man has a better option than the woman he is assigned to by the Gale-Shapley algorithm. In Agda:

\begin{code}%
\>[0]\AgdaComment{-- In order to define that a matching m₁ is better than a matching m₂,}\<%
\\
\>[0]\AgdaComment{-- we take into consideration that for all men they get a better}\<%
\\
\>[0]\AgdaComment{-- (earlier in their list) wife in m₁ than in m₂; this can be seen}\<%
\\
\>[0]\AgdaComment{-- from the size of his preference list in the final state of matching. }\<%
\\
\>[0]\AgdaFunction{is-better-matching}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m₁}\AgdaSpace{}%
\AgdaBound{m₂}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{MatchingState}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\<%
\\
\>[0]\AgdaFunction{is-better-matching}%
\>[3415I]\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[3415I]%
\>[19]\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men₁}\AgdaSpace{}%
\AgdaBound{freeMen₁}\AgdaSpace{}%
\AgdaBound{engagedMen₁}\AgdaSpace{}%
\AgdaBound{women₁}\AgdaSpace{}%
\AgdaBound{couples₁}\AgdaSpace{}%
\AgdaBound{k₁}\AgdaSpace{}%
\AgdaBound{p₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
%
\>[19]\AgdaFunction{is-stable-matching}\<%
\\
\>[19][@{}l@{\AgdaIndent{0}}]%
\>[21]\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men}\AgdaSpace{}%
\AgdaBound{freeMen}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaBound{women}\AgdaSpace{}%
\AgdaBound{couples}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\<%
\\
%
\>[19]\AgdaFunction{is-stable-matching}\<%
\\
\>[19][@{}l@{\AgdaIndent{0}}]%
\>[21]\AgdaSymbol{(}\AgdaInductiveConstructor{mkState}\AgdaSpace{}%
\AgdaBound{men₁}\AgdaSpace{}%
\AgdaBound{freeMen₁}\AgdaSpace{}%
\AgdaBound{engagedMen₁}\AgdaSpace{}%
\AgdaBound{women₁}\AgdaSpace{}%
\AgdaBound{couples₁}\AgdaSpace{}%
\AgdaBound{k₁}\AgdaSpace{}%
\AgdaBound{p₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\<%
\\
%
\>[19]\AgdaSymbol{((}\AgdaBound{m₁}\AgdaSpace{}%
\AgdaBound{m₂}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[19]\AgdaBound{m₁}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaBound{engagedMen}\AgdaSpace{}%
\AgdaSymbol{→}%
\>[38]\AgdaBound{m₂}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaBound{engagedMen₁}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[19]\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{m₁}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{m₂}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[19]\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{m₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{men}\<%
\\
%
\>[19]\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{m₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{men₁}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[19]\AgdaFunction{length}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{m₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≥}}\AgdaSpace{}%
\AgdaFunction{length}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{m₂}\AgdaSymbol{))}\<%
\\
\>[0]\<%
\end{code}

Let us define another possible stable matching from the first example given by Gale and Shapley:

\begin{code}%
\>[0]\AgdaComment{-- Let us demonstrate with the first canonical example. Gale and Shapley}\<%
\\
\>[0]\AgdaComment{-- tell us that another possible stable marriage (not returned by their}\<%
\\
\>[0]\AgdaComment{-- algorithm) is obtained by giving every woman her first choice:}\<%
\\
\>[0]\AgdaFunction{anotherPossibleStableMatching}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{MatchingState}\<%
\\
\>[0]\AgdaFunction{anotherPossibleStableMatching}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{mkState}%
\>[3483I]\AgdaFunction{listMen}\<%
\\
\>[.][@{}l@{}]\<[3483I]%
\>[40]\AgdaInductiveConstructor{[]}\<%
\\
%
\>[40]\AgdaSymbol{((}\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
%
\>[40]\AgdaFunction{listWomen}\<%
\\
%
\>[40]\AgdaSymbol{((}\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
%
\>[40]\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\>[40]\AgdaInductiveConstructor{refl}\<%
\end{code}

We go about proving it as we have seen before:

\begin{code}%
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{c₁}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaBound{c₁}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaField{MatchingState.couples}\AgdaSpace{}%
\AgdaFunction{anotherPossibleStableMatching}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[6]\AgdaBound{c₂}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaField{MatchingState.couples}\AgdaSpace{}%
\AgdaFunction{anotherPossibleStableMatching}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[6]\AgdaOperator{\AgdaFunction{¬}}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[6]\AgdaFunction{conditionOfStabilitySatisfied}\<%
\\
%
\>[6]\AgdaSymbol{(((}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{(}\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{MatchingState.men}\AgdaSpace{}%
\AgdaFunction{anotherPossibleStableMatching}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{((}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{(}\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{MatchingState.women}\AgdaSpace{}%
\AgdaFunction{anotherPossibleStableMatching}\AgdaSymbol{))))}\<%
\\
%
\>[6]\AgdaSymbol{(((}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{(}\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{MatchingState.men}\AgdaSpace{}%
\AgdaFunction{anotherPossibleStableMatching}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{((}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[6]\AgdaSymbol{(}\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{MatchingState.women}\AgdaSpace{}%
\AgdaFunction{anotherPossibleStableMatching}\AgdaSymbol{))))}\<%
\\
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3556I]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[3556I]%
\>[31]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
%
\>[31]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{⊥-elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{p}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3581I]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[3581I]%
\>[31]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
%
\>[31]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[3598I]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{())}\AgdaSpace{}%
\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[3598I][@{}l@{\AgdaIndent{0}}]%
\>[36]\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{())}\AgdaSpace{}%
\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3614I]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[3614I]%
\>[31]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
%
\>[31]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[3628I]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{())}\AgdaSpace{}%
\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[3628I][@{}l@{\AgdaIndent{0}}]%
\>[36]\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{())}\AgdaSpace{}%
\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3644I]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[3644I]%
\>[31]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\<%
\\
%
\>[31]\AgdaBound{p}\<%
\end{code}

Further cases are omitted for the sake of brevity, as it works exactly as the $matchIsStableHelper$ function discussed before.

\begin{code}[hide]%
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3659I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[3659I]%
\>[31]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
%
\>[31]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[3676I]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{())}\AgdaSpace{}%
\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[3676I][@{}l@{\AgdaIndent{0}}]%
\>[36]\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{())}\AgdaSpace{}%
\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3692I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
\>[.][@{}l@{}]\<[3692I]%
\>[31]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
%
\>[31]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[3706I]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{())}\AgdaSpace{}%
\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[3706I][@{}l@{\AgdaIndent{0}}]%
\>[36]\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{())}\AgdaSpace{}%
\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3722I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\<%
\\
\>[.][@{}l@{}]\<[3722I]%
\>[31]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
%
\>[31]\AgdaBound{p}\<%
\\
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3737I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[3737I]%
\>[31]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
%
\>[31]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{⊥-elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{p}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3756I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[3756I]%
\>[31]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
%
\>[31]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[3767I]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{())}\AgdaSpace{}%
\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[3767I][@{}l@{\AgdaIndent{0}}]%
\>[36]\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{())}\AgdaSpace{}%
\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3783I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[3783I]%
\>[31]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\<%
\\
%
\>[31]\AgdaBound{p}\<%
\\
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3795I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
\>[.][@{}l@{}]\<[3795I]%
\>[31]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
%
\>[31]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[3806I]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{())}\AgdaSpace{}%
\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[3806I][@{}l@{\AgdaIndent{0}}]%
\>[36]\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaSymbol{(\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}from>\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{())}\AgdaSpace{}%
\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3822I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\<%
\\
\>[.][@{}l@{}]\<[3822I]%
\>[31]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
%
\>[31]\AgdaBound{p}\<%
\\
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3834I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
\>[.][@{}l@{}]\<[3834I]%
\>[31]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
%
\>[31]\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{⊥-elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{p}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3847I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
\>[.][@{}l@{}]\<[3847I]%
\>[31]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\<%
\\
%
\>[31]\AgdaBound{p}\<%
\\
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3856I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\<%
\\
\>[.][@{}l@{}]\<[3856I]%
\>[31]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
%
\>[31]\AgdaBound{p}\<%
\\
\>[0]\AgdaFunction{anotherMatchIsStableHelper}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[3865I]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\<%
\\
\>[.][@{}l@{}]\<[3865I]%
\>[31]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)))}\<%
\\
%
\>[31]\AgdaBound{p}\<%
\end{code}

We are then able to give a proof that this second matching is also stable, but that it is not better than the first one, also by exhaustive pattern matching:

\begin{code}%
\>[0]\AgdaFunction{itIsAlsoStable}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{is-stable-matching}\AgdaSpace{}%
\AgdaFunction{anotherPossibleStableMatching}\<%
\\
\>[0]\AgdaFunction{itIsAlsoStable}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{anotherMatchIsStableHelper}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{matchIsBetterHelper}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m₁}\AgdaSpace{}%
\AgdaBound{m₂}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Σ}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaBound{m₁}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaField{MatchingState.engagedMen}\AgdaSpace{}%
\AgdaFunction{exEnd}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[6]\AgdaBound{m₂}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaField{MatchingState.engagedMen}\AgdaSpace{}%
\AgdaFunction{anotherPossibleStableMatching}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[6]\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{m₁}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{m₂}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[6]\AgdaSymbol{(}\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{m₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaFunction{listMen}\<%
\\
%
\>[6]\AgdaOperator{\AgdaDatatype{≡}}\<%
\\
%
\>[6]\AgdaFunction{getPreferenceList}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{m₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaFunction{listMen}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaSymbol{→}\<%
\\
%
\>[6]\AgdaFunction{length}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{m₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≥}}\AgdaSpace{}%
\AgdaFunction{length}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{m₂}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{matchIsBetterHelper}%
\>[3916I]\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\<%
\\
\>[.][@{}l@{}]\<[3916I]%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\\
\>[0]\AgdaFunction{matchIsBetterHelper}%
\>[3956I]\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\<%
\\
\>[.][@{}l@{}]\<[3956I]%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\\
\>[0]\AgdaFunction{matchIsBetterHelper}%
\>[3993I]\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\<%
\\
\>[.][@{}l@{}]\<[3993I]%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\\
\>[0]\AgdaFunction{matchIsBetterHelper}%
\>[4027I]\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaBound{m₂}\<%
\\
\>[.][@{}l@{}]\<[4027I]%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\<%
\\
%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\<%
\\
\>[0]\AgdaFunction{matchIsBetterHelper}%
\>[4057I]\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\<%
\\
\>[.][@{}l@{}]\<[4057I]%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\\
\>[0]\AgdaFunction{matchIsBetterHelper}%
\>[4090I]\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\<%
\\
\>[.][@{}l@{}]\<[4090I]%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\\
\>[0]\AgdaFunction{matchIsBetterHelper}%
\>[4116I]\AgdaBound{m₁}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\<%
\\
\>[.][@{}l@{}]\<[4116I]%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\<%
\\
%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\<%
\\
\>[0]\AgdaFunction{matchIsBetterHelper}%
\>[4134I]\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\<%
\\
\>[.][@{}l@{}]\<[4134I]%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\\
\>[0]\AgdaFunction{matchIsBetterHelper}%
\>[4164I]\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\<%
\\
\>[.][@{}l@{}]\<[4164I]%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\\
\>[0]\AgdaFunction{matchIsBetterHelper}%
\>[4191I]\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaBound{m₂}\<%
\\
\>[.][@{}l@{}]\<[4191I]%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\<%
\\
%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\<%
\\
\>[0]\AgdaFunction{matchIsBetterHelper}%
\>[4214I]\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\<%
\\
\>[.][@{}l@{}]\<[4214I]%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\\
\>[0]\AgdaFunction{matchIsBetterHelper}%
\>[4237I]\AgdaBound{m₁}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\<%
\\
\>[.][@{}l@{}]\<[4237I]%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\<%
\\
%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.((}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\<%
\\
\>[0]\AgdaFunction{matchIsBetterHelper}%
\>[4252I]\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\<%
\\
\>[.][@{}l@{}]\<[4252I]%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\\
\>[0]\AgdaFunction{matchIsBetterHelper}%
\>[4272I]\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{1}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaNumber{3}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{∷}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaBound{m₂}\<%
\\
\>[.][@{}l@{}]\<[4272I]%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\<%
\\
%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\<%
\\
\>[0]\AgdaFunction{matchIsBetterHelper}%
\>[4288I]\AgdaBound{m₁}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaNumber{2}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaDottedPattern{\AgdaSymbol{)}}\<%
\\
\>[.][@{}l@{}]\<[4288I]%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\<%
\\
%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{now}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{[]}}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\<%
\\
\>[0]\AgdaFunction{matchIsBetterHelper}%
\>[4300I]\AgdaBound{m₁}\AgdaSpace{}%
\AgdaBound{m₂}\<%
\\
\>[.][@{}l@{}]\<[4300I]%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{())))}\<%
\\
%
\>[20]\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{later}\AgdaSpace{}%
\AgdaBound{p₂}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaBound{p₃}\AgdaSpace{}%
\AgdaBound{p₄}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{matchIsBetter}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{is-better-matching}\AgdaSpace{}%
\AgdaFunction{exEnd}\AgdaSpace{}%
\AgdaFunction{anotherPossibleStableMatching}\<%
\\
\>[0]\AgdaFunction{matchIsBetter}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{matchIsStable}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{itIsAlsoStable}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{matchIsBetterHelper}\<%
\\
\>[0]\<%
\end{code}

We postulate that a proof can be written for any stable matching in the same vein as the example above: 

\begin{code}%
\>[0]\AgdaComment{-- Given two stable matchings m₁ , m₂}\<%
\\
\>[0]\AgdaComment{-- where m₁ is the result of the computation of}\<%
\\
\>[0]\AgdaComment{-- the Gale-Shapley algorithm}\<%
\\
\>[0]\AgdaComment{-- and m₂ is a matching over the same man and women,}\<%
\\
\>[0]\AgdaComment{-- m₂ is at most as good as m₁ but no better.}\<%
\\
\>[0]\AgdaKeyword{postulate}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaPostulate{pAnyMatchIsBetter}%
\>[4320I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{m₁}\AgdaSpace{}%
\AgdaBound{m₂}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{MatchingState}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
\>[4320I][@{}l@{\AgdaIndent{0}}]%
\>[21]\AgdaFunction{allSteps}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{m₁}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[21]\AgdaField{MatchingState.men}\AgdaSpace{}%
\AgdaBound{m₂}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaField{MatchingState.men}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[21]\AgdaField{MatchingState.women}\AgdaSpace{}%
\AgdaBound{m₂}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaField{MatchingState.women}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[21]\AgdaFunction{is-stable-matching}\AgdaSpace{}%
\AgdaBound{m₁}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{is-stable-matching}\AgdaSpace{}%
\AgdaBound{m₂}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[21]\AgdaFunction{is-better-matching}\AgdaSpace{}%
\AgdaBound{m₁}\AgdaSpace{}%
\AgdaBound{m₂}\<%
\\
\>[0]\<%
\end{code}}
